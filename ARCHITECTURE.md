# Архитектура BIM-стека

## Обзор компонентов

### 1. Traefik (Reverse Proxy)
- **Назначение**: Единая точка входа для всех сервисов
- **Порт**: 80 (HTTP), 443 (HTTPS), 8080 (Dashboard)
- **Функции**:
  - Автоматическая маршрутизация запросов
  - Управление сертификатами (для продакшена)
  - Load balancing
  - Health checks

### 2. Portainer
- **Назначение**: Веб-интерфейс для управления Docker
- **Доступ**: http://localhost/portainer
- **Функции**:
  - Управление контейнерами
  - Просмотр логов
  - Мониторинг ресурсов

### 3. PostgreSQL (2 экземпляра)
- **postgres_bim**: База данных для BIMserver
- **postgres_nc**: База данных для Nextcloud
- **Версия**: 15-alpine
- **Преимущества разделения**:
  - Изоляция данных
  - Независимое масштабирование
  - Разные политики резервного копирования

### 4. Redis
- **Назначение**: Кеширование и блокировки для Nextcloud
- **Функции**:
  - Ускорение работы Nextcloud
  - Управление сессиями
  - Очереди задач

### 5. BIMserver
- **Назначение**: Хранилище и управление IFC-моделями
- **Доступ**: http://localhost/bimserver
- **Функции**:
  - Загрузка IFC-файлов
  - Версионирование моделей
  - REST API для доступа к данным
  - Хранение в PostgreSQL

### 6. Nextcloud
- **Назначение**: Файловый CDE (Common Data Environment)
- **Доступ**: http://localhost/nextcloud
- **Функции**:
  - Хранение файлов
  - Управление пользователями
  - Совместная работа
  - Интеграции с другими системами

### 7. xeokit Viewer
- **Назначение**: 3D-просмотр IFC-моделей в браузере
- **Доступ**: http://localhost/viewer
- **Функции**:
  - Визуализация BIM-моделей
  - Интеграция с BIMserver API
  - Интерактивная навигация

## Сетевая архитектура

```
Internet
   |
   v
[Traefik:80/443]
   |
   +---> [Nextcloud:80] <---> [PostgreSQL NC] <---> [Redis]
   |
   +---> [BIMserver:8080] <---> [PostgreSQL BIM]
   |
   +---> [xeokit:80] ---> [BIMserver API]
   |
   +---> [Portainer:9000]
```

### Сети Docker

1. **bim_web** (web)
   - Публичная сеть
   - Содержит: Traefik, Nextcloud, BIMserver, xeokit, Portainer
   - Доступна извне через Traefik

2. **bim_internal** (internal)
   - Внутренняя сеть для баз данных
   - Содержит: PostgreSQL, Redis
   - Изолирована от прямого внешнего доступа

## Потоки данных

### Загрузка IFC-модели
1. Пользователь → Traefik → BIMserver
2. BIMserver → PostgreSQL (сохранение метаданных)
3. BIMserver → Файловая система (сохранение IFC)

### Просмотр модели
1. Пользователь → Traefik → xeokit Viewer
2. xeokit → Traefik → BIMserver API
3. BIMserver → PostgreSQL (получение метаданных)
4. BIMserver → Файловая система (чтение IFC)
5. BIMserver → xeokit (передача данных модели)
6. xeokit → Браузер (рендеринг 3D)

### Работа с файлами
1. Пользователь → Traefik → Nextcloud
2. Nextcloud → PostgreSQL (метаданные)
3. Nextcloud → Redis (кеш, блокировки)
4. Nextcloud → Файловая система (файлы)

## Хранение данных

### Volumes
- `data/postgres_bim/` - база данных BIMserver
- `data/postgres_nc/` - база данных Nextcloud
- `data/redis/` - данные Redis
- `data/bimserver/` - IFC-файлы и конфигурация
- `data/nextcloud/` - файлы пользователей
- `data/traefik/` - сертификаты и конфигурация
- `data/portainer/` - настройки Portainer

### Конфигурации
- `config/traefik/` - настройки Traefik
- `config/bimserver/` - настройки BIMserver
- `config/nextcloud/` - настройки Nextcloud
- `config/xeokit/` - настройки viewer

## Безопасность

### Текущая конфигурация (локальная разработка)
- HTTP только (без HTTPS)
- Пароли по умолчанию
- Открытый доступ к Portainer
- Открытый доступ к Traefik Dashboard

### Для продакшена необходимо:
1. Настроить HTTPS с реальными сертификатами
2. Изменить все пароли по умолчанию
3. Ограничить доступ к Portainer и Traefik Dashboard
4. Настроить файрвол
5. Регулярно обновлять образы
6. Настроить резервное копирование

## Масштабирование

### Горизонтальное масштабирование
- **Nextcloud**: Можно добавить несколько экземпляров за Traefik
- **BIMserver**: Можно добавить несколько экземпляров для обработки
- **PostgreSQL**: Можно настроить репликацию

### Вертикальное масштабирование
- Увеличить лимиты памяти для контейнеров
- Настроить swap для PostgreSQL
- Оптимизировать настройки JVM для BIMserver

## Мониторинг

### Доступные инструменты
- **Portainer**: Базовый мониторинг контейнеров
- **Traefik Dashboard**: Статистика запросов
- **Docker logs**: Логи всех сервисов

### Рекомендуемые дополнения
- Prometheus + Grafana для метрик
- ELK Stack для централизованных логов
- Health checks для всех сервисов

## Резервное копирование

### Критичные данные
1. **Базы данных PostgreSQL**: Ежедневные дампы
2. **Файлы Nextcloud**: Регулярное копирование
3. **IFC-модели BIMserver**: Регулярное копирование
4. **Конфигурации**: Версионирование в Git

### Стратегия
- Автоматические дампы баз данных
- Инкрементальное копирование файлов
- Хранение резервных копий вне контейнеров


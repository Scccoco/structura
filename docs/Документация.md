# Документация: З_900_10_Материалы_Все

## Назначение
Унифицированная таблица материалов из **трёх источников**: РД (рабочая документация), Смета, 1С. 
Каждая строка привязана к **GUID элемента BIM-модели** — ключ для интеграции со Speckle.

---

## Структура таблицы (15 колонок)

| # | Колонка | Тип | Описание |
|---|---------|-----|----------|
| 1 | **GUID_** | Text | **Ключ связи со Speckle**. Уникальный идентификатор элемента BIM-модели (Revit). |
| 2 | Имя_ | Text | Имя элемента в модели ("Балка стеновая", "Плита перекрытия") |
| 3 | Позиция_ | Text | Позиция элемента ("ПП-5.1", "Б1.1") |
| 4 | Этаж_ | Text | Этаж расположения элемента |
| 5 | БазовыйОбъемМодель | Double | Объём элемента из BIM-модели (м³) |
| 6 | НомерСметы | Text | Номер локальной сметы |
| 7 | Раздел | Text | Раздел сметы ("Плиты перекрытия и монолитные конструкции...") |
| 8 | КонструкцияСметы | Text | Конструкция по смете ("Устройство монолитных балок -0,100") |
| 9 | Конструкция1С | Text | Конструкция из 1С (если применимо) |
| 10 | **Источник** | Text | Источник данных: `'РД'`, `'Смета'`, `'1С'` |
| 11 | Наименование | Text | Название материала ("Бетон B30, W8", "арматура А500 12") |
| 12 | ТипГруппы | Text | Тип материала: `'Бетон'`, `'арматура'` |
| 13 | **Количество** | Double | Количество материала (распределённое на GUID) |
| 14 | ЕдИзм | Text | Единица измерения: `'м3'` (бетон), `'кг'` (арматура) |
| 15 | Документ | Text | Документ-источник ("РД", номер сметы, тип 1С) |

---

## Связь со Speckle

```
GUID_ (в этой таблице) = speckle_object.applicationId (в Speckle)
```

**Ключевое**: `GUID_` — это `applicationId` элемента Revit, который сохраняется при публикации в Speckle. Используй его для JOIN между данными материалов и геометрией в Speckle.

---

## Источники данных

### РД (Рабочая документация)
- **Что**: Материалы из ведомостей расхода материалов (РД)
- **Источник SQL**: `З_900_01_Материалы_РД`
- **Логика расчёта**: Количество распределяется на GUID через `ДоляПозиции` и `ДоляGUID`
- **Исходные данные**: `Т_200_200_МатериалыРД` (импорт из Excel)

### Смета
- **Что**: Материалы из локальных смет (ЛСР)
- **Источник SQL**: `З_900_02_Материалы_Смета`
- **Логика расчёта**: Детализация сметных позиций на GUID через привязку к конструкциям
- **Исходные данные**: `Т_600_ЛСР` (импорт из Excel/ГРАНД-Смета)

### 1С
- **Что**: Фактические материалы из учётной системы 1С
- **Источник SQL**: `З_900_03_Материалы_1С`
- **Логика расчёта**: Связь через маппинг конструкций (Смета ↔ 1С)
- **Исходные данные**: `Т_800_1С` (выгрузка из 1С)

---

## Алгоритм распределения материалов на GUID

```
┌─────────────────────────────────────────────────────────────────┐
│ Материал_Группа (общее количество на группу элементов)          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Расчёт ОбъёмПозиции = Σ Объём по каждой Позиции в группе        │
│ Расчёт ОбъёмГруппы = Σ Объём всех позиций в группе              │
│ ДоляПозиции = ОбъёмПозиции / ОбъёмГруппы                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Расчёт ОбъёмGUID = Объём конкретного GUID                        │
│ Расчёт ОбъёмПозиции = Σ Объём всех GUID в позиции               │
│ ДоляGUID = ОбъёмGUID / ОбъёмПозиции                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ КоличествоНаGUID = Материал_Группа × ДоляПозиции × ДоляGUID     │
└─────────────────────────────────────────────────────────────────┘
```

---

## Типичные запросы для дашбордов

### Сравнение источников по конструкции
```sql
SELECT 
    КонструкцияСметы,
    Источник,
    ТипГруппы,
    SUM(Количество) AS Всего
FROM З_900_10_Материалы_Все
GROUP BY КонструкцияСметы, Источник, ТипГруппы
```

### Расхождение РД vs 1С по GUID
```sql
SELECT 
    GUID_,
    ТипГруппы,
    SUM(IIf(Источник='РД', Количество, 0)) AS РД,
    SUM(IIf(Источник='1С', Количество, 0)) AS Факт1С,
    SUM(IIf(Источник='РД', Количество, 0)) - SUM(IIf(Источник='1С', Количество, 0)) AS Расхождение
FROM З_900_10_Материалы_Все
WHERE Источник IN ('РД', '1С')
GROUP BY GUID_, ТипГруппы
```

### Агрегация по этажам
```sql
SELECT Этаж_, Источник, ТипГруппы, SUM(Количество) AS Всего
FROM З_900_10_Материалы_Все
GROUP BY Этаж_, Источник, ТипГруппы
```

---

## Единицы измерения

| Материал | ЕдИзм | Примечание |
|----------|-------|------------|
| Бетон | м³ | Кубические метры |
| Арматура | кг | Килограммы (в исходных — тонны, конвертировано ×1000) |

---

## Рекомендации для интеграции

1. **Загрузка в БД**: Экспортируй таблицу из Access в CSV/Excel, загрузи в PostgreSQL/SQLite
2. **Связь со Speckle**: Используй `GUID_` как внешний ключ к `applicationId` в Speckle объектах
3. **Индексы**: Создай индексы на `GUID_`, `Источник`, `ТипГруппы`, `КонструкцияСметы`
4. **Типы данных**: `Количество` и `БазовыйОбъемМодель` — numeric/decimal для точности

---

## Версии таблиц

| Таблица | Описание |
|---------|----------|
| `З_900_10_Материалы_Все` | Материалы распределённые на GUID (для визуализации в 3D) |
| `З_900_12_Материалы_Исходные` | Исходные материалы без распределения (для проверки сумм) |

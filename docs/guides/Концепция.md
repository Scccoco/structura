---

---

# 1. Концепция событийной модели данных

---

Система предназначена для управления данными строительного проекта через фиксацию **фактов и состояний**, а не через хранение файлов в папочной структуре.

В основе лежит событийная модель: каждый значимый факт фиксируется в виде записи в реестре событий и связывается с объектами проекта и BIM-моделью.

## 1.1. Роль папок и файлового хранилища

Файловое хранилище используется для хранения бинарных данных (PDF, Excel, фото), но не является логической моделью данных проекта.

Основные положения:

- **Источник истины** — запись события в базе данных и её связи.
    
    Путь к файлу не несёт смысловой нагрузки.
    
- **Папочная структура** используется только для навигации и удобства пользователей.
    
    Она не определяет статус, версию или принадлежность файла к процессу.
    
- **Файлы существуют в системе только как вложения событий.**
    
    Загрузка файла без создания события не допускается.
    

Таким образом, логика системы строится вокруг событий и связей, а не вокруг структуры папок.

## 1.2. Определение события

**Событие** — это запись в системе, фиксирующая конкретный факт изменения состояния проекта, данных или документации.

Каждое событие описывается следующим набором компонентов:

Событие = {Тип + Контекст + Объект + Атрибуты + Вложения + Статус}

Где:

1. **Тип** — что именно произошло
    
    (поступление РД, выпуск новой версии, подписание акта, списание материалов).
    
2. **Контекст** — проект, этап или договор, к которому относится событие.
3. **Объект** — привязка к цифровому скелету:
    
    элемент BIM-модели, узел (опора), захватка или иной агрегированный объект.
    
    Событие без объекта считается некорректным.
    
4. **Атрибуты** — структурированные данные
    
    (номер, дата, ответственный, комментарии).
    
5. **Вложения** — файлы, связанные с событием и хранящиеся в Nextcloud.
6. **Статус** — состояние обработки
    
    (черновик, валидировано, отклонено).
    

## 1.3. Минимально допустимое событие

Для снижения порога входа и исключения блокировки рабочих процессов вводится понятие черновика события.

Минимальный набор данных для создания события:

- тип события;
- проект;
- объект (не ниже верхнего уровня);
- хотя бы один файл.

Все дополнительные атрибуты и связи могут быть заполнены позже в процессе валидации.

## 1.4. Цифровой след документа

Документ в системе рассматривается как зафиксированное состояние на момент события.

Основные правила:

- Загруженный и зафиксированный файл не редактируется и не заменяется.
- При изменении документа создаётся новое событие, а не замена файла.
- Новые события ссылаются на предыдущие версии, формируя цепочку изменений.
- Старые версии не удаляются, а помечаются как неактуальные.

Это обеспечивает полную прослеживаемость истории изменений.

## 1.5. Классификация событий

События разделяются на несколько функциональных групп:

1. **Документальные**
    
    Поступление, обновление и аннулирование РД, смет и исполнительной документации.
    
2. **Производственные**
    
    Фиксация фактических работ и операций на объекте.
    
3. **Системные**
    
    Служебные события: синхронизация с BIM-моделью, контроль целостности данных, аудит.
    

---

**Ключевое правило системы:**

Файл, не связанный с событием и объектом, не участвует в процессах и не используется системой, независимо от того, где он физически хранится.

# Блок 2. Роли, дисциплина данных и логические сущности системы

Качество данных в системе обеспечивается не регламентами и не «дисциплиной пользователей», а архитектурой ролей, состояний и сущностей.

Система спроектирована с учётом того, что авторы работают в условиях ограниченного времени.

Требования к полноте и корректности данных переносятся на этап валидации и реализуются средствами системы.

---

## 2.1. Функциональные роли

В системе используются три функциональные роли.

Один пользователь может совмещать несколько ролей, однако **в рамках одного события роли не пересекаются**.

### Автор (инженер)

**Назначение роли:**

Фиксация факта выполнения действия или появления документа.

**Действия в системе:**

- создание события в статусе «Черновик»;
- загрузка файлов;
- указание минимального контекста (проект, объект верхнего уровня).

**Ответственность:**

- наличие цифрового следа события;
- корректный выбор типа события по смыслу.

---

### Валидатор (архивариус, BIM-координатор)

**Назначение роли:**

Преобразование черновика в структурированную и связную запись.

**Действия в системе:**

- проверка состава и качества файлов;
- формирование документов и пакетов;
- заполнение и проверка атрибутов;
- привязка события к объектам цифрового скелета и внешним источникам данных;
- перевод события в статус «Валидировано».

**Ответственность:**

- целостность и чистота реестра;
- отсутствие дублей;
- корректная объектная и предметная привязка данных.

---

### Потребитель (ГИП, руководитель, заказчик)

**Назначение роли:**

Принятие управленческих решений на основе валидированных данных.

**Действия в системе:**

- работа с витринами, отчётами и дашбордами;
- инициирование управленческих событий.

**Ответственность:**

- принятие решений;
- фиксация решений исключительно через события, а не через редактирование данных.

---

**Базовый принцип разделения ролей:**

Пользователь, создавший событие, не может валидировать это же событие.

---

## 2.2. Жизненный цикл события

Система использует двухфазную модель обработки событий.

Цель модели — не блокировать фиксацию фактов и при этом сохранить контроль качества данных.

---

### Фаза 1. Черновик

Режим быстрого ввода, ориентированный на фиксацию факта.

**Минимально допустимый состав события:**

- тип события;
- проект;
- объект верхнего уровня;
- файлы.

**Свойства фазы:**

- событие не участвует в аналитике и отчётах;
- данные могут быть возвращены автору на доработку;
- файлы не считаются источником истины.

---

### Фаза 2. Валидация

Перевод события в официальный слой данных.

**Действия валидатора:**

- структурирование файлов в документы и пакеты;
- заполнение и проверка атрибутов;
- объектная привязка к BIM-модели;
- проверка хешей и выявление дублей.

**Результат:**

- событие становится источником истины;
- файлы и атрибуты блокируются для изменения;
- данные включаются в витрины и аналитику.

---

## 2.3. Утверждение как отдельное событие

Ручное утверждение каждого документа создаёт узкое место и плохо масштабируется.

По управленческим решениям пока не знаю что писатть.

---

## 2.4. Поддержка валидации и коммуникации

Система помогает валидатору, но не подменяет его решения.

Поддерживающие механизмы:

- **хеш-контроль** — выявление потенциальных дублей файлов;
- **возврат через задачу** — возврат события автору оформляется как действие, а не сообщение;
- **изоляция хранилища** — прямой доступ к файловому серверу отсутствует у всех ролей.

---

## 2.5. Ошибки, аннулирование и замены

Удаление валидированных данных запрещено.

Используются следующие механизмы:

- **аннулирование** — создание нового события со ссылкой на ошибочное;
- **замена версии** — создание нового события, предыдущее сохраняется как неактуальное;
- **история изменений** — цепочка событий хранится полностью и не переписывается.

---

## 2.6. Логические сущности системы

### 2.6.1. Иерархия артефактов

Событие не оперирует файлами напрямую, а работает с логическими сущностями.

- **Файл (Binary)**

Физический объект в файловом хранилище. Неделим.

- **Документ**

Смысловая единица, объединяющая один или несколько файлов.

Основные метаданные (номер, дата, тип) привязываются к документу.

- **Пакет (Комплект)**

Логическая группа документов, необходимая для закрытия задачи или этапа.

- **Событие**

Единственный механизм управления: создаёт документы, формирует пакеты, управляет актуальностью.

---

### 2.6.2. Простые и сложные атрибуты

**Простые атрибуты**

- хранятся в основной таблице событий;
- используются для фильтрации, поиска и группировки.

Примеры: проект, тип события, дата, статус, ответственный.

**Сложные атрибуты**

- хранятся в связанных реляционных таблицах;
- используются для расчётов и аналитики;
- формируются через процедуры разноски.

Примеры: позиции сметы, объёмы из 1С, перечни GUID элементов модели.

---

### 2.6.3. Задача как проекция состояния

В системе отсутствует отдельная сущность «Задача».

**Принцип:**

Задача — это представление события для пользователя в текущем статусе.

Примеры:

- статус «Черновик» → задача «Загрузить / дополнить»;
- статус «На валидации» → задача «Проверить / разнести»;
- статус «Возврат» → задача «Исправить».

Такой подход позволяет вести пользователя по процессу без использования BPMN-движка.

---

### 2.6.4. Устойчивость к замене модели

Связи в системе строятся на уровне предметных сущностей, а не только на BIM-ID.

При обновлении модели:

- элементы с сохранёнными GUID автоматически сохраняют связи;
- элементы с новыми GUID требуют осознанного маппинга;
- история событий по предыдущим версиям модели сохраняется полностью.

Далее подробно раскрывается этот вопрос

---

## 2.7. Пример: Акт списания материалов

**Кейс:** списание бетона на колонны 1 этажа.

### Точка входа (Автор)

- создаёт событие «Списание материалов»,
- загружает фото или PDF акта,
- указывает проект и объект.

Результат: событие в статусе «Черновик».

---

### Валидация (Валидатор)

- сопоставляет данные с выгрузкой из 1С,
- привязывает событие к GUID ростверка в Speckle,
- формирует сложные атрибуты.

Результат: событие валидировано, данные записаны в базу данных.

---

### Аналитика (Потребитель)

- открывает дашборд,
- видит статус объекта,
- принимает решение на основе валидированных данных.

---

### Принципиальный вывод

> Если файл лежит на сервере, но на него нет записи в реестре событий —
> 
> 
> **для системы он не существует**.
> 
> Источник истины — это запись + связи, а не файл сам по себе.
> 

# Блок 3. Типизация событий (Общие правила)

Данный блок задаёт **универсальный стандарт фиксации фактов** в системе.

Он определяет, какие требования предъявляются к любому событию, независимо от дисциплины: рабочая документация, сметы, производство, исполнительная документация, материалы.

Цель блока — создать **единый «контейнер события»**, в который может быть упакован любой процесс, без переписывания архитектуры под каждый новый кейс.

---

## 3.1. Принципы типизации событий

### 3.1.1. Предметность имен

Тип события должен отражать **суть действия в предметной области**, а не результат аналитики или этап обработки данных.

Корректно:

- Выпуск/замена РД
- Списание материалов
- Загрузка акта исполнительной документации

---

### 3.1.2. Атомарность

Одно событие фиксирует **один управленческий или производственный факт**.

Если в реальности произошло несколько действий, они фиксируются несколькими связанными событиями.

Пример:

- «Согласовать и списать» — это два события.
- «Выпустить РД и разослать» — это два события.

Связи между событиями допустимы и поощряются, но сами события остаются атомарными.

---

### 3.1.3. Обязательная объектность

Событие не существует в вакууме.

Каждое событие обязательно привязывается к объекту цифрового скелета.

Объектом может быть:

- конкретный элемент BIM-модели (Speckle GUID),
- агрегированный узел (Опора, Захватка, Участок),
- проект в целом (только для системных и управленческих событий).

События без объектной привязки в системе не допускаются.

---

### 3.1.4. Разделение данных и подтверждений

Событие хранит **данные** (атрибуты).

Файлы, прикреплённые к событию, являются **подтверждением этих данных**, а не источником истины.

Источник истины:

- запись в базе данных,
- её связи,
- её статус валидации.

Файл — это цифровой след, а не управляющий объект.

---

## 3.2. Универсальная анатомия события

Любое событие в системе, независимо от дисциплины, имеет **единую логическую структуру**, реализуемую на уровне базы данных.

---

### 3.2.1. Слой простых атрибутов

Этот слой используется для:

- реестров,
- фильтрации,
- навигации,
- витрин данных.

Содержит:

- **Тип события**
    
    Системный код (строка).
    
- **Контекст**
    
    Проект, договор или иной верхнеуровневый идентификатор.
    
- **Связь с объектом**
    
    Ссылка на узел цифрового скелета или конкретный Speckle GUID.
    
- **Временная метка события**
    
    Дата фактического действия (не дата создания записи).
    
- **Статус события**
    
    Черновик / Валидировано / Аннулировано.
    
    Статус отражает техническое состояние записи в системе, а не управленческое решение.
    

---

### 3.2.2. Слой сложных атрибутов

Этот слой используется для:

- расчётов,
- аналитики,
- отчётов,
- интеграции с внешними системами.

Данные хранятся в связанных таблицах и могут отличаться по структуре в зависимости от типа события.

Типовые группы сложных атрибутов:

- **Ресурсная часть**
    
    Связи со строками внешних систем (1С, сметные базы).
    
- **Геометрическая часть**
    
    Один или несколько Speckle GUID элементов модели, на которые влияет событие.
    
- **Количественная часть**
    
    Объёмы, массы, стоимости, коэффициенты распределения.
    

Работа с этим слоем требует процедуры оцифровки и валидации.

---

## 3.3. Базовые дисциплины (Категории событий)

Для пилотного внедрения система опирается на три базовые дисциплины.

Каждая дисциплина имеет своего владельца данных и различную глубину детализации.

### 3.3.1. Рабочая документация (РД)

События, формирующие **план**:

- что должно быть построено,
- в каком составе,
- по какой версии проектных решений.

### 3.3.2. Сметы

События, формирующие **стоимость**:

- за что платят,
- в каком объёме,
- по каким позициям.

### 3.3.3. Исполнительная документация и Производство

События, фиксирующие **факт**:

- что реально выполнено,
- когда,
- в каком объёме,
- с какими отклонениями.

---

## 3.4. Стресс-кейс: Списание материалов

Данный кейс используется как проверка универсальности модели.

Он связывает бухгалтерию, производство и BIM-модель.

---

### 3.4.1. Смысл и тип события

**Тип события:** СПИСАНИЕ_МАТЕРИАЛОВ

**Смысл:**

Увязка списанного по ресурса с конкретными элементами цифрового скелета.

---

### 3.4.2. Структура данных события

**Простые атрибуты:**

- Дата акта,
- Номер акта М-29,
- Ответственный инженер,
- Объект верхнего уровня Колонны 1 этажа.

**Сложные атрибуты:**

- **1С-Link:**
    
    Список строк из выгрузки 1С
    
    (Код материала, Наименование, Количество, Ед. изм.).
    
- **BIM-Link:**
    
    Набор Speckle GUID элементов
    
    (например, ростверк Опоры №3).
    

---

### 3.4.3. Интерфейс валидации («Три окна»)

Рабочее место Валидатора для данного кейса строится по принципу одновременного контекста:

- **Окно 1 — Документ**
    
    Скан акта М-29 из Nextcloud (подтверждение факта).
    
- **Окно 2 — Внешняя система**
    
    Таблица выгрузки из 1С.
    
- **Окно 3 — Модель**
    
    Speckle Viewer для выбора элементов.
    

Валидатор осознанно формирует связи:

[Строка 1С] + [Элемент модели] + [Документ].

---

### 3.4.4. Оценка трудоёмкости (инженерный прогноз)

- **Техническая часть:**
    
    Реляционные таблицы сложных атрибутов (Postgres) — 1–2 дня.
    
- **Интерфейсная часть:**
    
    Модуль сопоставления таблица ↔ модель (Refine) — 3–5 дней.
    
- **Методологическая часть:**
    
    Поддержка справочников сопоставления материалов — непрерывный процесс.
    

---

## Резюме блока

Блок 3 фиксирует единый стандарт:

> Событие — это универсальный контейнер данных.
> 
> 
> У него всегда есть простой слой для навигации и сложный слой для расчётов.
> 
> Любой процесс — от выпуска РД до списания материалов — укладывается в эту структуру без изменения архитектуры.
> 

Кейс со списанием материалов подтверждает, что модель позволяет связать даже разнородные системы (1С и Speckle), сохраняя прозрачность, прослеживаемость и контроль трудоёмкости.

# Блок 4. Атрибуты, справочники и границы системы

Данный блок определяет:

- какие данные хранятся в системе,
- какие используются из внешних источников,
- какие рассчитываются,
- какие находятся за пределами ответственности системы.

Цель блока — зафиксировать границы системы и предотвратить её неконтролируемое разрастание в сторону бухгалтерских или процессных платформ.

---

## 4.1. Принцип разделения ответственности

Система событийного учёта **не является универсальным хранилищем всех данных проекта**.

Она выполняет функции интеграционного слоя, который:

- фиксирует факты в виде событий,
- хранит связи между данными,
- обеспечивает прослеживаемость изменений,
- формирует витрины и аналитические представления.

**Базовый принцип:**

Если данные уже корректно ведутся во внешней системе, они не дублируются, а связываются.

---

## 4.2. Классификация данных по источнику истины

Все данные, используемые в системе, разделяются на четыре категории.

---

### 4.2.1. Внутренние данные системы

Данные, которые создаются и управляются исключительно внутри системы.

К ним относятся:

- события и их типы,
- статусы событий,
- связи между событиями,
- связи событий с объектами цифрового скелета,
- связи между версиями (замена, аннулирование).

**Источник истины:** PostgreSQL (база structura).

Эти данные не импортируются и не синхронизируются извне.

---

### 4.2.2. Импортируемые данные (внешние источники)

Данные, которые формируются во внешних системах и используются в системе как контекст или основание для событий.

Примеры:

- строки списания из 1С,
- сметные позиции,
- классификаторы материалов,
- ведомости объёмов работ.

**Правило использования:**

- система хранит копию данных, необходимую для работы,
- но не является их первоисточником.

Обновление таких данных выполняется:

- через повторный импорт,
- через загрузку новой версии набора данных,
- без перезаписи ранее зафиксированной истории.

---

### 4.2.3. BIM-данные (цифровой скелет)

Геометрия и свойства элементов информационной модели.

Примеры:

- GUID элементов,
- типы элементов,
- проектные объёмы,
- принадлежность к узлам (опора, пролет, захватка).

**Источник истины:** BIM-модель, загружаемая через Speckle.

Система:

- не редактирует геометрию,
- хранит копию модели в качестве коммитов

---

### 4.2.4. Производные (рассчитываемые) данные

Данные которые заносятся в систему пользователями (инженеры ПТО. Инженера ОТиЗ) через веб-модули.

---

## 4.3. Простые атрибуты как системные справочники

Простые атрибуты используются для:

- фильтрации,
- сортировки,
- построения витрин и списков.

К ним предъявляются требования:

- стабильность значений,
- ограниченный набор допустимых значений,
- централизованное управление.

Примеры справочников:

- типы событий,
- проекты,
- роли пользователей,
- статусы,
- категории документов.

**Важно:**

Простые атрибуты не должны требовать ручной разноски или сложной логики заполнения.

---

## 4.4. Сложные атрибуты и правила их формирования

Сложные атрибуты появляются только после валидации события.

Их характерные признаки:

- связь с несколькими таблицами,
- участие в расчётах,
- зависимость от внешних данных.

Примеры:

- распределение материалов по GUID элементов,
- разбиение одной строки 1С на несколько элементов модели,
- агрегирование данных по захваткам.

**Правило:**

Если атрибут невозможно корректно заполнить на этапе быстрого ввода, он не должен быть обязательным в черновике.

---

## 4.5. Справочники сопоставления (Mapping Tables)

Отдельный класс сущностей составляют справочники сопоставления.

Их назначение:

- связывать различные системы координат и терминологии,
- обеспечивать повторяемость принятых решений,
- снижать объём ручной работы при валидации.

Примеры:

- «материал в 1С» → «категория элемента BIM»,
- «тип работы» → «набор допустимых элементов модели».

**Особенность:**

Справочники сопоставления не являются завершёнными и требуют постоянного сопровождения по мере развития проекта.

---

## 4.6. Границы системы

Для сохранения управляемости системы фиксируются следующие ограничения.

Система не:

- заменяет 1С,
- реализует полноценный BPMN-движок,
- редактирует BIM-модели,
- навязывает сложную форму ввода данных.

Система:

- фиксирует события,
- связывает данные между источниками,
- управляет состояниями,
- обеспечивает прозрачность и прослеживаемость.

---

## Резюме блока

Система не является универсальным хранилищем данных.

Она выполняет роль связующего слоя между фактами, документами и моделью, с чётко определёнными границами ответственности.

Фиксация этих границ позволяет:

- прогнозировать трудоёмкость развития,
- избегать архитектурного разрастания,
- масштабировать систему без пересмотра базовых принципов.

# Блок 5. Пользовательские сценарии и интерфейсная логика

Данный блок описывает, как архитектура событий, ролей и атрибутов реализуется в пользовательском интерфейсе и какие сценарии работы доступны разным ролям.

Интерфейс системы строится вокруг **состояний событий**, а не вокруг структуры данных или форм.

---

## 5.1. Общий принцип интерфейса

Система не использует жёстко заданные процессные сценарии и не требует от пользователя понимания внутренней структуры данных.

Интерфейс реализует следующую логику:

- данные формируют состояние,
- состояние формирует доступную задачу,
- задача определяется ролью пользователя.

Задача не является отдельной сущностью.

Она определяется сочетанием события, его статуса и роли пользователя.

Один и тот же объект данных отображается по-разному:

- для автора — как действие ввода,
- для валидатора — как действие проверки и связывания,
- для руководителя — как источник аналитики.

---

## 5.2. Роль: Автор (Инженер)

### Назначение роли

Фиксация факта выполнения действия или получения документа с минимальными затратами времени.

---

### Интерфейс роли

Автору доступен ограниченный набор экранов:

- список текущих задач,
- кнопка создания нового события.

Реестры, справочники и аналитические экраны автору недоступны.

---

### Сценарий: создание события

1. Пользователь инициирует создание события.
2. Выбирает тип события из ограниченного перечня.
3. Указывает объект верхнего уровня (опора, участок, захватка).
4. Загружает файлы (фото, сканы, PDF).

Заполнение дополнительных атрибутов на этом этапе не требуется.

---

### Результат сценария

- создаётся событие в статусе «Черновик»,
- файлы загружаются в файловое хранилище,
- событие передаётся в очередь на валидацию.

Автор не участвует в последующей проверке, связывании и расчётах.

---

## 5.3. Роль: Валидатор (Архивариус/ BIM-координатор)

### Назначение роли

Преобразование черновых событий в структурированные и проверенные данные.

---

### Интерфейс роли

Валидатору доступен интерфейс:

- очереди событий на валидации,
- списка возвратов,
- приоритетов обработки.

---

### Сценарий: валидация события

1. Валидатор открывает событие в статусе «Черновик».
2. Проверяет состав и содержание файлов.
3. Формирует документы и пакеты.
4. Заполняет и уточняет атрибуты.
5. Выполняет привязку:
    - к данным внешних систем,
    - к элементам BIM-модели.
6. Проверяет дубли и хеш-совпадения.
7. Переводит событие в статус «Валидировано».

---

### Контекстная рабочая среда

Все действия выполняются в одном интерфейсе, включающем:

- просмотр документов,
- работу с табличными данными,
- BIM-модель в Speckle Viewer.

Валидатор принимает решения осознанно и вручную.

---

### Результат сценария

- данные становятся доступными для аналитики,
- событие считается источником истины,
- файлы и атрибуты блокируются от изменений.

---

## 5.4. Роль: Потребитель (ГИП / Руководитель)

### Назначение роли

Работа с валидированным слоем данных для анализа и принятия решений.

---

### Интерфейс роли

Потребителю доступны:

- дашборды,
- витрины данных,
- BIM-визуализация статусов.

Недоступны:

- черновики,
- возвращённые события,
- технические статусы обработки.

---

### Типовые сценарии использования

- анализ готовности конструктивов,
- контроль план–фактных показателей,
- проверка закрытия этапов,
- анализ отклонений.

---

### Управленческие действия

Если требуется формальная фиксация решения:

- создаётся отдельное событие (например, «Приёмка этапа»),
- событие ссылается на набор валидированных событий.

Решения не изменяют данные напрямую и фиксируются только через события.

---

## 5.5. Логика задач и состояний

Система не использует отдельную сущность «Задача».

Задача определяется следующим образом:

**Задача = событие + статус + роль пользователя.**

Примеры:

- статус «Черновик» → действие «Дополнить»,
- статус «На валидации» → действие «Проверить»,
- статус «Возврат» → действие «Исправить».

Такой подход исключает дублирование логики и упрощает масштабирование.

---

## 5.6. Интерфейс как следствие архитектуры

Интерфейс является прямым отражением архитектуры данных и состояний.

Он:

- не навязывает пользователю последовательность действий,
- не требует изучения структуры системы,
- отображает только актуальные действия для текущей роли.

---

## Резюме блока

Интерфейс системы разделён по ролям и состояниям событий.

Каждый пользователь работает только с теми действиями, которые соответствуют его роли и текущему состоянию данных, без доступа к избыточным функциям и техническим деталям.

# Блок 6. Витрины данных, отчёты и аналитика

Данный блок описывает, **как события и связи превращаются в представления**, удобные для разных ролей: инженера, ПТО, ГИПа, заказчика.

Ключевая идея: **папки и отчёты — это не структура хранения, а результат запроса к данным**.

---

## 6.1. Принцип витрин данных

В системе отсутствует фиксированная папочная структура как источник истины.

Все представления данных являются:

- **виртуальными**,
- **динамическими**,
- **воспроизводимыми**.

**Витрина данных** — это сохранённый запрос к реестру событий и связанным таблицам.

---

## 6.2. Папка как результат запроса

Папка в интерфейсе — это не место хранения файлов, а **отфильтрованная выборка событий и документов**.

Примеры виртуальных папок:

- «Исполнительная документация по Опоре №3»,
- «Актуальная РД, ревизия 5»,
- «Списания бетона за май».

Физическое расположение файлов при этом не имеет значения.

---

## 6.3. Классификация витрин

Витрины делятся по назначению.

---

### 6.3.1. Операционные витрины

Используются для ежедневной работы.

Примеры:

- очередь событий на валидацию,
- список возвратов,
- незакрытые задачи.

Источник данных:

- простые атрибуты,
- статусы событий.

---

### 6.3.2. Инженерные витрины

Используются для контроля хода работ.

Примеры:

- готовность конструктивов,
- наличие ИД по элементам,
- соответствие факта проекту.

Источник данных:

- валидированные события,
- связи с BIM-моделью.

---

### 6.3.3. Управленческие витрины

Используются для принятия решений.

Примеры:

- план–факт по объёмам,
- прогресс по этапам,
- отклонения и риски.

Источник данных:

- агрегированные сложные атрибуты,
- расчётные показатели.

---

### 6.3.4. Внешние витрины (для заказчика)

Используются для передачи информации наружу.

Примеры:

- комплект ИД по договору,
- архив актуальной РД и т.д.,

Особенность:

- фиксированная структура,
- отсутствие черновиков,
- только актуальные данные.

---

## 6.4. Отчёты как надстройка над витринами

Отчёт — это формализованная витрина с:

- жёсткой структурой,
- фиксированным составом полей,
- возможностью выгрузки (PDF, Excel).

Примеры:

- ВОР,
- реестр ИД,
- отчёт о списании материалов.

**Важно:**

Отчёты не хранят данные. Они **собираются каждый раз заново** из реестра событий.

---

## 6.5. Связь аналитики и модели (BIM)

Аналитика может быть проецирована на модель.

Примеры:

- окраска элементов по статусу ИД,
- визуализация перерасхода материалов,
- индикация непринятых работ.

Источник:

- валидированные события,
- производные показатели.

Модель при этом:

- не изменяется,
- не дублируется,
- используется как визуальный слой.

---

## 6.6. Историчность и «срезы во времени»

Система позволяет получать состояние проекта **на любую дату**.

Примеры:

- какие документы были актуальны месяц назад,
- какой был план–факт на дату сдачи этапа,
- по какой версии модели принимались решения.

Это достигается за счёт:

- неизменяемости событий,
- явных связей «заменяет / заменено»,
- отсутствия перезаписи данных.

---

## 6.7. Ограничения аналитики

Система осознанно:

- не выполняет сложные финансовые расчёты
- не заменяет BI-платформы,
- не хранит дублирующие агрегаты.

Её задача:

- предоставить **чистые, связные данные**,
- на основе которых аналитика воспроизводима и проверяема.

## Блок 7. BIM как цифровой скелет и контур сохранности данных

В системе BIM-модель используется как **цифровой скелет проекта** — структурная и геометрическая основа, к которой привязываются события, документы и производственные факты.

При этом модель **не является хранилищем бизнес-данных** и не используется как источник управленческих состояний.

---

## 7.1. Роль BIM-модели в системе

BIM-модель отвечает на три класса вопросов:

- **Состав:** какие элементы существуют в проекте.
- **Структура:** где элементы находятся (узлы, уровни, захватки, опоры).
- **Плановые характеристики:** проектные объёмы, типы, параметры.

Модель используется:

- как источник идентификаторов элементов,
- как геометрическая иерархия,
- как визуальный инструмент контроля и анализа.

Модель **не хранит**:

- факты выполнения,
- документы,
- статусы,
- управленческие решения.

---

## 7.2. Speckle как BIM-платформа

Speckle используется как платформа для работы с BIM-моделью и обеспечивает:

- версионирование моделей (commits),
- хранение структуры и параметров элементов,
- хранение геометрии в объектном хранилище (S3 / MinIO),
- визуализацию и сравнение ревизий,
- доступ к модели через визуализатор.

С точки зрения данных Speckle включает:

- объектное хранилище геометрии,
- служебные базы PostgreSQL для структуры, коммитов и метаданных.

---

## 7.3. Принцип разделения ответственности данных

Архитектура системы намеренно разделяет хранение геометрии и хранение бизнес-фактов.

**Speckle отвечает за:**

- геометрию,
- структуру модели,
- версии и визуализацию изменений.

**База данных `structura` отвечает за:**

- события и их статусы,
- документы и пакеты,
- связи «событие ↔ элемент / узел»,
- данные из внешних систем (1С, сметы, РД),
- историю замен, аннулирований и решений.

Это разделение исключает зависимость бизнес-логики от внутренней схемы Speckle и защищает данные при изменении модели.

---

## 7.4. GUID как ключ связности

Связующим элементом между BIM и бизнес-данными является GUID элемента.

GUID используется как:

- ключ привязки событий и документов,
- ключ для расчётов план–факт,
- идентификатор для визуализации статусов во вьювере.

При сохранении GUID между ревизиями все связи сохраняются автоматически.

При изменении GUID требуется явное сопоставление.

---

## 7.5. Снимок модели в базе `structura`

Для устойчивой работы системы используется не «живая» модель Speckle, а её зафиксированное представление.

При каждой загрузке новой версии модели:

- структура модели извлекается,
- записывается в `structura` как **снимок ревизии**.

Снимок содержит:

- ссылку на commit Speckle,
- GUID элементов,
- типы и базовые параметры,
- принадлежность к узлам и структуре проекта.

Снимки:

- неизменяемы,
- не перезаписываются,
- позволяют восстановить состояние модели на любую дату.

---

## 7.6. Миграция связей при обновлении модели

После записи нового снимка выполняется сравнение с предыдущей ревизией.

Элементы классифицируются на три группы:

- **совпавшие по GUID** — связи сохраняются автоматически,
- **новые элементы** — доступны для новой разноски,
- **исчезнувшие элементы** — остаются в истории и помечаются как отсутствующие в актуальной модели.

Ни один элемент и ни одно событие не удаляются.

---

## 7.7. Контроль изменений и сопоставление элементов

Speckle используется как инструмент визуального контроля изменений модели.

Валидатор получает:

- список элементов с нарушенной связностью,
- визуальное сравнение ревизий во вьювере.

Для элементов с изменившимися GUID используется механизм явного сопоставления:

- старый GUID ↔ новый GUID,
- фиксация пользователя, времени и основания решения.

После подтверждения:

- новый GUID наследует всю цепочку событий и документов,
- история не переписывается,
- сохраняется прослеживаемость между ревизиями.

---

## Резюме блока

BIM-модель задаёт структуру и геометрию проекта.

Все бизнес-факты, документы и решения хранятся и управляются вне модели.

Использование снимков модели и явного сопоставления элементов гарантирует, что:

- данные не теряются при смене ревизий,
- история остаётся воспроизводимой,
- миграция связей происходит осознанно и контролируемо.

### 7.8. Роль валидатора при изменении BIM-модели

Механизм снимков модели и сравнения ревизий используется в первую очередь как **рабочий инструмент валидатора**, а не как фоновая автоматизация.

После загрузки новой версии модели валидатор получает:

- перечень элементов, у которых изменился GUID,
- перечень новых элементов,
- перечень элементов, исчезнувших из актуальной ревизии.

Для этих элементов валидатор работает не «вслепую», а в контексте:

- визуального сравнения ревизий в Speckle Viewer,
- истории событий и документов, уже привязанных к элементу,
- структуры узлов и захваток проекта.

На этом основании валидатор принимает осознанное решение:

- считать элемент тем же самым (создать сопоставление старого и нового GUID),
- считать элемент новым,
- оставить элемент только в истории без наследования связей.

Таким образом:

- система не делает скрытых перепривязок,
- валидатор всегда видит, **где и почему нарушилась связность**,
- все решения по миграции данных фиксируются и могут быть проверены.

Этот подход позволяет сохранять данные при изменении модели, не теряя контроля над их корректностью и происхождением.

# Блок 8. Техническая архитектура и потоки данных

Этот блок описывает, **как физически устроена система**, какие инструменты используются и как данные проходят путь от пользователя до аналитики.

Архитектура построена так, чтобы:

- данные не терялись при изменении BIM-моделей,
- не возникало «двух истин»,
- все управленческие решения можно было восстановить задним числом,
- система могла развиваться поэтапно, без ломки ядра.

---

## 8.1. Общий принцип архитектуры

Ключевой принцип:

> Каждый тип данных хранится там, где ему место, и имеет ровно один источник истины.
> 

Мы сознательно разделяем:

- геометрию,
- файлы,
- бизнес-данные,
- аналитику.

Это устраняет конфликты, дублирование и ручные «сшивки».

---

## 8.2. Компоненты и технологический стек

### Frontend (Пользовательский интерфейс)

**Refine.dev + React**

Используется как фреймворк для построения интерфейсов поверх данных.

**Ant Design**

UI-библиотека для форм, таблиц, фильтров и списков задач.

**Speckle Viewer SDK**

Встроенный BIM-вьювер:

- визуализация модели,
- выбор элементов,
- подсветка статусов и результатов расчетов.
- внесение бизнес-данных непосредственно в модели

**Пояснение:**

Интерфейс — это не «окно в базу», а рабочее место пользователя, где он:

- выполняет свои задачи,
- видит только актуальные данные,
- не может случайно повредить систему.

---

### API слой

**PostgREST**

Автоматически формирует REST API поверх PostgreSQL.

**PostgreSQL RPC-функции**

Используются для:

- валидации событий,
- агрегатов,
- формирования витрин,
- операций, где важна целостность данных.

**Пояснение:**

API — это контролируемый шлюз.

Пользовательский интерфейс **не имеет прямого доступа к базе данных**, что:

- исключает ошибки,
- исключает несанкционированные изменения,
- позволяет чётко управлять правами и логикой.

---

### Data слой (Бизнес-данные)

**PostgreSQL 15**

Используются две базы:

**speckle**

Служебная база Speckle Server.

Отвечает за:

- структуру моделей,
- версии,
- внутреннюю логику Speckle.

**structura**

Наша бизнес-база данных цифрового двойника.

В ней хранится:

- реестр событий,
- документы и пакеты,
- связи с BIM,
- статусы,
- история изменений,
- расчетные витрины.

**Пояснение:**

Именно `structura` является **центральным ядром системы**.

Если данных нет здесь — для системы их не существует.

---

### BIM слой

**Speckle Server**

Платформа управления BIM-моделями и версиями.

**MinIO**

S3-хранилище геометрии.

**Redis**

Кеш Speckle для ускорения работы.

**Пояснение:**

Speckle используется строго по назначению — как система работы с моделями.

Бизнес-логика и управленческие данные в него не «запихиваются».

---

### Файловый слой

**Nextcloud**

Используется как:

- файловое хранилище,
- пользовательский доступ к документам,
- архив бинарных данных.

**Интеграция через WebDAV API**

**Пояснение для руководства:**

Nextcloud отвечает только за файлы.

Он **не знает**, что такое «акт», «событие» или «статус».

Весь смысл хранится в базе данных, а не в папках.

---

### Аналитика

**Grafana**

Используется для:

- управленческих дашбордов,
- контроля статусов,
- план-факт анализа.

Источник данных — SQL-витрины PostgreSQL.

---

### Инфраструктура

**Docker Compose**

Вся система разворачивается как единый набор сервисов.

**Traefik**

Reverse proxy и SSL.

**Пояснение:**

Это позволяет:

- быстро разворачивать систему,
- контролировать окружение,
- не зависеть от конкретного сервера или подрядчика.

---

## 8.3. Где находится «истина»

Чтобы избежать конфликтов и дублирования, источник истины определён жёстко.

**Speckle**

- истина по геометрии,
- иерархии элементов,
- версиям моделей.

**Nextcloud**

- истина по бинарным файлам,
- физическому хранению документов.

**PostgreSQL structura**

- истина по событиям,
- документам и пакетам,
- связям с объектами и элементами,
- статусам и валидации,
- истории изменений,
- расчетам и витринам.

---

## 8.4. Потоки данных (без автоматической обработки)

На текущем этапе **все действия выполняются человеком**.

Система ничего не делает сама.

---

### 8.4.1. Поток 1. Загрузка BIM-модели и обновление цифрового скелета

1. Пользователь загружает модель в Speckle.
2. Система получает ссылку на commit и метаданные ревизии.
3. По инициативе пользователя запускается извлечение структуры модели.
4. В `structura` создается новый снимок цифрового скелета.
5. Выполняется сравнение с предыдущей ревизией.
6. Формируется перечень:
    - совпавших элементов,
    - новых элементов,
    - исчезнувших элементов.
7. Пользователь подтверждает или корректирует миграцию связей.
8. История сохраняется полностью.

**Важно:**

Система **ничего не перепривязывает автоматически**.

Все спорные места остаются видимыми человеку.

---

### 8.4.2. Поток 2. Создание события и загрузка файлов

1. Пользователь вручную создает событие в интерфейсе.
2. UI создает запись события в `structura` со статусом «Черновик».
3. Пользователь загружает файлы в Nextcloud через UI.
4. В `structura` сохраняются ссылки на файлы.
5. Файлы объединяются в Документ и, при необходимости, в Пакет.

**Принцип:**

Файлы без события для системы не существуют.

Папочная структура Nextcloud — вспомогательная, не логическая.

---

### 8.4.3. Поток 3. Валидация и ручная оцифровка

1. Валидатор открывает черновик события.
2. В интерфейсе доступны:
    - прикрепленные документы,
    - справочные и внешние данные (например, выгрузка 1С),
    - BIM-модель в Speckle Viewer.
3. Валидатор вручную:
    - проверяет атрибуты,
    - связывает строки данных с элементами модели,
4. Данные записываются в реляционные таблицы как сложные атрибуты.
5. Событие переводится в статус «Валидировано».

---

### 8.4.4. Поток 4. Аналитика и визуализация

1. В `structura` формируются SQL-витрины и представления.
2. UI читает витрины через PostgREST.
3. Grafana использует те же представления для дашбордов.
4. Speckle Viewer подсвечивает элементы по статусам и расчетам.

Одна и та же логика используется:

- в интерфейсе,
- в отчетах,
- в визуализации модели.

---

## 8.5. Потоки данных по ролям

**Инженер**

- создает события,
- загружает файлы,
- исправляет замечания.

**Валидатор**

- проверяет данные,
- связывает документы, внешние источники и модель,
- подтверждает события.

**Руководитель**

- работает только с валидированным слоем,
- смотрит витрины, дашборды и BIM-визуализацию,
- не участвует во вводе данных.

# Блок 9. Пользовательский интерфейс, роли и контроль действий

Этот блок описывает, **как роли разделены именно в интерфейсе**, что видит каждый пользователь и почему через UI невозможно сделать «лишнее».

---

## 9.1. Принцип разделения ролей в интерфейсе

В системе **нет одного универсального интерфейса для всех**.

Интерфейс:

- адаптируется под роль пользователя,
- показывает только разрешённые действия,
- скрывает недоступные сценарии.

Пользователь не выбирает роль сам.

Роль назначается администратором и определяет **набор экранов и доступных операций**.

---

## 9.2. Как это выглядит для пользователя

После входа в систему пользователь попадает **на разную стартовую страницу** в зависимости от роли.

Это не «один и тот же экран с серыми кнопками», а **разные рабочие сценарии**.

---

## 9.3. Интерфейс инженера

**Назначение роли:** ввод первичных данных.

### Что видит инженер

- раздел «События»,
- список своих черновиков,
- формы создания новых событий,
- загрузку файлов,
- BIM-модель в режиме просмотра.

### Что может делать

- создать событие,
- прикрепить файлы,
- заполнить атрибуты,
- сохранить черновик,
- отправить событие на валидацию.

### Чего не может

- валидировать события,
- менять утверждённые данные,
- удалять историю,
- влиять на аналитические витрины.

> В интерфейсе инженера нет кнопок, которые могут привести к необратимым изменениям.
> 

---

## 9.4. Интерфейс валидатора

**Назначение роли:** проверка и подтверждение данных.

### Что видит валидатор

- список событий, ожидающих проверки,
- историю изменений по каждому событию,
- прикреплённые документы,
- BIM-модель с возможностью связывания элементов,
- справочные и внешние данные.

### Что может делать

- проверять корректность атрибутов,
- связывать данные с элементами модели,
- задавать коэффициенты и распределения,
- возвращать событие на доработку,
- переводить событие в статус «Валидировано».

### Чего не может

- редактировать уже валидированные события,
- удалять файлы,
- подменять историю.

> Валидация — это отдельный экран и отдельное действие, а не галочка в форме.
> 

---

## 9.5. Интерфейс руководителя

**Назначение роли:** контроль и анализ.

### Что видит руководитель

- дашборды,
- агрегированные показатели,
- витрины данных,
- BIM-модель с цветовой индикацией статусов,
- только валидированные данные.

### Что может делать

- фильтровать,
- сравнивать,
- анализировать,
- просматривать первоисточники при необходимости.

### Чего не может

- создавать события,
- редактировать данные,
- загружать файлы,
- вмешиваться во ввод информации.

> Руководитель работает только с проверенным слоем, без риска случайного влияния на данные.
> 

---

## 9.6. Разделение интерфейса технически

С точки зрения интерфейса:

- разные роли → разные страницы,
- разные роли → разные меню,
- разные роли → разные формы и действия.

Это не один интерфейс с ограничениями, а **набор сценариев**, включаемых по роли.

Пользователь просто **не видит** того, что ему нельзя.

---

## 9.7. Защита от ошибок через интерфейс

Даже если пользователь ошибся:

- он работает только в своём контуре,
- не может перейти границу ответственности,
- не может «сломать» данные проекта.

Интерфейс:

- не предлагает опасных действий,
- не перегружен лишними функциями,
- ведёт пользователя по разрешённому сценарию.

---

## 9.8. Почему такой подход выбран

Этот подход:

- снижает количество ошибок,
- снижает нагрузку на обучение,
- повышает доверие к данным,
- упрощает контроль и аудит.

> Система не требует обучения и квалификации для отдельных ролей
> 
> 
> Она проектируется под реальную работу.
>
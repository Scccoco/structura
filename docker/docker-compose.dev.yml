# Локальная разработка - PathPrefix роутинг
# Запуск: docker-compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d
# НЕ коммитится в Git!

version: '3.8'

services:
  # Traefik для локальной разработки (без HTTPS)
  traefik:
    image: traefik:v2.11
    container_name: traefik_dev
    restart: unless-stopped
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - web
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=bim_web
      - --entrypoints.web.address=:80
      - --log.level=DEBUG
    labels:
      - "traefik.enable=true"

  # BIMserver - локальный доступ через /bimserver
  bimserver:
    build:
      context: ./bimserver
      dockerfile: Dockerfile
    container_name: bimserver_dev
    restart: unless-stopped
    environment:
      - CATALINA_OPTS=-Xmx2g -Xms1g -Djava.awt.headless=true
      - BIMSERVER_DATABASE_TYPE=postgresql
      - BIMSERVER_DATABASE_HOST=postgres_bim
      - BIMSERVER_DATABASE_PORT=5432
      - BIMSERVER_DATABASE_NAME=${POSTGRES_BIM_DB:-bimserver}
      - BIMSERVER_DATABASE_USER=${POSTGRES_BIM_USER:-bimserver}
      - BIMSERVER_DATABASE_PASSWORD=${POSTGRES_BIM_PASSWORD:-bimserver_pass}
    volumes:
      - ../data/bimserver:/var/lib/bimserver
      - ../config/bimserver:/bimserver-home
    networks:
      - web
      - internal
    depends_on:
      postgres_bim:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8080/bimserver/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=bim_web"
      - "traefik.http.routers.bimserver-dev.rule=PathPrefix(`/bimserver`)"
      - "traefik.http.routers.bimserver-dev.entrypoints=web"
      - "traefik.http.routers.bimserver-dev.service=bimserver-dev"
      - "traefik.http.routers.bimserver-dev.priority=100"
      - "traefik.http.services.bimserver-dev.loadbalancer.server.port=8080"

  # Nextcloud - локальный доступ через /nextcloud
  nextcloud:
    image: nextcloud:32-apache
    container_name: nextcloud_dev
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=postgres_nc
      - POSTGRES_DB=${POSTGRES_NC_DB:-nextcloud}
      - POSTGRES_USER=${POSTGRES_NC_USER:-nextcloud}
      - POSTGRES_PASSWORD=${POSTGRES_NC_PASSWORD:-nextcloud_pass}
      - REDIS_HOST=redis
      - REDIS_HOST_PASSWORD=${REDIS_PASSWORD:-redis_pass}
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost
      - NEXTCLOUD_ADMIN_USER=admin_local
      - NEXTCLOUD_ADMIN_PASSWORD=NextcloudLocal_2025!
      - APACHE_DOCUMENTROOT=/var/www/html
      - OVERWRITEPROTOCOL=http
    volumes:
      - ../data/nextcloud:/var/www/html
    networks:
      - web
      - internal
    depends_on:
      postgres_nc:
        condition: service_healthy
      redis:
        condition: service_healthy
    # healthcheck:
    #   test: ["CMD-SHELL", "curl -f http://localhost/ || exit 1"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 5
    #   start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=bim_web"
      - "traefik.http.routers.nextcloud-dev.rule=PathPrefix(`/nextcloud`)"
      - "traefik.http.routers.nextcloud-dev.entrypoints=web"
      - "traefik.http.routers.nextcloud-dev.middlewares=nextcloud-stripprefix"
      - "traefik.http.routers.nextcloud-dev.service=nextcloud-dev"
      - "traefik.http.routers.nextcloud-dev.priority=100"
      - "traefik.http.services.nextcloud-dev.loadbalancer.server.port=80"
      - "traefik.http.middlewares.nextcloud-stripprefix.stripprefix.prefixes=/nextcloud"

  # Portainer - прямой порт 9000
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer_dev
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../data/portainer:/data
    ports:
      - "9000:9000"
    networks:
      - web

  # Speckle Server - Frontend (Local Dev)
  speckle-frontend:
    image: speckle/speckle-frontend-2:latest
    container_name: speckle-frontend_dev
    restart: unless-stopped
    ports:
      - "3000:8080"
    environment:
      - NUXT_PUBLIC_SERVER_NAME=Structura Speckle (Dev)
      - NUXT_PUBLIC_API_ORIGIN=http://localhost:3001
      - NUXT_PUBLIC_BACKEND_API_ORIGIN=http://localhost:3001/graphql
      - FRONTEND_ORIGIN=http://localhost:3000
    networks:
      - web

  # Speckle Server - Backend API (Local Dev)
  speckle-server:
    image: speckle/speckle-server:latest
    container_name: speckle-server_dev
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - CANONICAL_URL=http://localhost:3001
      - SESSION_SECRET=local_dev_secret_change_in_prod
      - STRATEGY_LOCAL=true
      - DEBUG=speckle:*
      - POSTGRES_URL=postgres://${POSTGRES_SPECKLE_USER:-speckle}:${POSTGRES_SPECKLE_PASSWORD:-speckle_pass}@postgres_speckle:5432/${POSTGRES_SPECKLE_DB:-speckle}
      - REDIS_URL=redis://default:${REDIS_PASSWORD:-redis_pass}@redis:6379
      - S3_ENDPOINT=http://minio:9000
      - S3_PUBLIC_ENDPOINT=http://localhost:9000
      - S3_IGNORE_SSL=true
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=speckle-server
      - S3_CREATE_BUCKET=true
      - S3_FORCE_PATH_STYLE=true
      - EMAIL=false
      - FRONTEND_ORIGIN=http://localhost:3000
      - DISABLE_WORKSPACES=true
      - MINIO_SERVER_URL=http://localhost:9000
      - MINIO_API_CORS_ALLOW_ORIGIN=http://localhost:3000
    networks:
      - web
      - internal
    depends_on:
      postgres_speckle:
        condition: service_healthy
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.speckle-api.rule=Host(`localhost`) && PathPrefix(`/graphql`, `/api`, `/objects`, `/auth`, `/explorer`)"
      - "traefik.http.routers.speckle-api.entrypoints=web"
      - "traefik.http.services.speckle-api.loadbalancer.server.port=3000"

  # Speckle Preview Service (Local Dev)
  speckle-preview:
    image: speckle/speckle-preview-service:latest
    container_name: speckle-preview_dev
    restart: unless-stopped
    environment:
      - DEBUG=preview-service:*
      - PG_CONNECTION_STRING=postgres://${POSTGRES_SPECKLE_USER:-speckle}:${POSTGRES_SPECKLE_PASSWORD:-speckle_pass}@postgres_speckle:5432/${POSTGRES_SPECKLE_DB:-speckle}
      - REDIS_URL=redis://default:${REDIS_PASSWORD:-redis_pass}@redis:6379
      - SPECKLE_SERVER_URL=http://speckle-server:3000
      - PORT=3000
      - S3_ENDPOINT=http://minio:9000
    networks:
      - internal
    depends_on:
      postgres_speckle:
        condition: service_healthy

  # Speckle Webhook Service (Local Dev)
  speckle-webhook:
    image: speckle/speckle-webhook-service:latest
    container_name: speckle-webhook_dev
    restart: unless-stopped
    environment:
      - DEBUG=webhook-service:*
      - PG_CONNECTION_STRING=postgres://${POSTGRES_SPECKLE_USER:-speckle}:${POSTGRES_SPECKLE_PASSWORD:-speckle_pass}@postgres_speckle:5432/${POSTGRES_SPECKLE_DB:-speckle}
      - REDIS_URL=redis://default:${REDIS_PASSWORD:-redis_pass}@redis:6379
      - SPECKLE_SERVER_URL=http://speckle-server:3000
      - PORT=3000
    networks:
      - internal
    depends_on:
      postgres_speckle:
        condition: service_healthy

  # Speckle File Import Service (Local Dev)
  speckle-fileimport:
    image: speckle/speckle-fileimport-service:latest
    container_name: speckle-fileimport_dev
    restart: unless-stopped
    environment:
      - DEBUG=fileimport-service:*
      - PG_CONNECTION_STRING=postgres://${POSTGRES_SPECKLE_USER:-speckle}:${POSTGRES_SPECKLE_PASSWORD:-speckle_pass}@postgres_speckle:5432/${POSTGRES_SPECKLE_DB:-speckle}
      - REDIS_URL=redis://default:${REDIS_PASSWORD:-redis_pass}@redis:6379
      - S3_ENDPOINT=http://minio:9000
      - S3_PUBLIC_ENDPOINT=http://localhost:9000
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=speckle-server
      - SPECKLE_SERVER_URL=http://speckle-server:3000
      - PORT=3000
      - FILE_IMPORT_TIME_LIMIT_MIN=60
    networks:
      - internal
    depends_on:
      postgres_speckle:
        condition: service_healthy

  # Speckle Adapter - Custom Python Service for GUID extraction
  speckle-adapter:
    build:
      context: ../backend/speckle_adapter
      dockerfile: Dockerfile
    container_name: speckle-adapter
    restart: unless-stopped
    ports:
      - "8090:8000"
    environment:
      - SPECKLE_SERVER_URL=http://speckle-server_dev:3000
      - SPECKLE_TOKEN=${SPECKLE_TOKEN}
      - ALLOW_ORIGINS=*
    networks:
      - web
      - internal
    depends_on:
      speckle-server:
        condition: service_started

  # MinIO Local Configuration (CORS fix)
  minio:
    environment:
      - MINIO_SERVER_URL=http://localhost:9000
      - MINIO_BROWSER_REDIRECT_URL=http://localhost:9001
      - MINIO_API_CORS_ALLOW_ORIGIN=*

# Продакшн конфигурация - VPS с доменами и HTTPS
# Запуск на VPS: docker-compose -f docker-compose.base.yml -f docker-compose.prod.yml up -d

version: '3.8'

services:
  # Traefik - Reverse Proxy с HTTPS
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/dynamic.yml:/dynamic.yml:ro
      - ../data/traefik:/data
    networks:
      - web
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.file.filename=/dynamic.yml
      - --providers.file.watch=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.letsencrypt.acme.email=scccoco55@gmail.com
      - --certificatesresolvers.letsencrypt.acme.storage=/data/acme.json
      - --log.level=INFO
    labels:
      - "traefik.enable=true"

  # Portainer
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../data/portainer:/data
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`port.structura-most.ru`)"
      - "traefik.http.routers.portainer.entrypoints=web"
      - "traefik.http.routers.portainer.middlewares=portainer-https-redirect"
      - "traefik.http.routers.portainer-secure.rule=Host(`port.structura-most.ru`)"
      - "traefik.http.routers.portainer-secure.entrypoints=websecure"
      - "traefik.http.routers.portainer-secure.tls=true"
      - "traefik.http.routers.portainer-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.portainer-secure.service=portainer"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
      - "traefik.http.middlewares.portainer-https-redirect.redirectscheme.scheme=https"

  # Nextcloud
  nextcloud:
    image: nextcloud:32-apache
    container_name: nextcloud
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=postgres_nc
      - POSTGRES_DB=${POSTGRES_NC_DB:-nextcloud}
      - POSTGRES_USER=${POSTGRES_NC_USER:-nextcloud}
      - POSTGRES_PASSWORD=${POSTGRES_NC_PASSWORD:-nextcloud_pass}
      - REDIS_HOST=redis
      - REDIS_HOST_PASSWORD=${REDIS_PASSWORD:-redis_pass}
      - NEXTCLOUD_TRUSTED_DOMAINS=cloud.structura-most.ru
      - APACHE_DOCUMENTROOT=/var/www/html
      - OVERWRITEPROTOCOL=https
    volumes:
      - ../data/nextcloud:/var/www/html
    networks:
      - web
      - internal
    depends_on:
      postgres_nc:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`cloud.structura-most.ru`)"
      - "traefik.http.routers.nextcloud.entrypoints=web"
      - "traefik.http.routers.nextcloud.middlewares=nextcloud-https-redirect"
      - "traefik.http.routers.nextcloud-secure.rule=Host(`cloud.structura-most.ru`)"
      - "traefik.http.routers.nextcloud-secure.entrypoints=websecure"
      - "traefik.http.routers.nextcloud-secure.tls=true"
      - "traefik.http.routers.nextcloud-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.nextcloud-secure.middlewares=nextcloud-headers"
      - "traefik.http.routers.nextcloud-secure.service=nextcloud"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
      - "traefik.http.middlewares.nextcloud-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.nextcloud-https-redirect.redirectscheme.scheme=https"

  # Speckle Server - Frontend
  speckle-frontend:
    image: speckle/speckle-frontend-2:latest
    container_name: speckle-frontend
    restart: unless-stopped
    environment:
      - NUXT_PUBLIC_SERVER_NAME=Structura Speckle
      - NUXT_PUBLIC_API_ORIGIN=https://speckle.structura-most.ru
      - NUXT_PUBLIC_BACKEND_API_ORIGIN=https://speckle.structura-most.ru/graphql
      - FRONTEND_ORIGIN=https://speckle.structura-most.ru
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.speckle-frontend.rule=Host(`speckle.structura-most.ru`)"
      - "traefik.http.routers.speckle-frontend.entrypoints=web"
      - "traefik.http.routers.speckle-frontend.middlewares=speckle-https-redirect"
      - "traefik.http.routers.speckle-frontend-secure.rule=Host(`speckle.structura-most.ru`)"
      - "traefik.http.routers.speckle-frontend-secure.entrypoints=websecure"
      - "traefik.http.routers.speckle-frontend-secure.tls=true"
      - "traefik.http.routers.speckle-frontend-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.speckle-frontend-secure.service=speckle-frontend"
      - "traefik.http.services.speckle-frontend.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.speckle-https-redirect.redirectscheme.scheme=https"

  # Speckle Server - Backend API
  speckle-server:
    image: speckle/speckle-server:latest
    container_name: speckle-server
    restart: unless-stopped
    environment:
      - CANONICAL_URL=https://speckle.structura-most.ru
      - SESSION_SECRET=${SPECKLE_SESSION_SECRET:-change_this_secret}
      - STRATEGY_LOCAL=true
      - DEBUG=speckle:*
      - POSTGRES_URL=postgres://${POSTGRES_SPECKLE_USER:-speckle}:${POSTGRES_SPECKLE_PASSWORD:-speckle_pass}@postgres_speckle:5432/${POSTGRES_SPECKLE_DB:-speckle}
      - REDIS_URL=redis://default:${REDIS_PASSWORD:-redis_pass}@redis:6379
      - S3_ENDPOINT=http://minio:9000
      - S3_PUBLIC_ENDPOINT=https://s3.structura-most.ru
      - S3_IGNORE_SSL=true
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=speckle-server
      - S3_CREATE_BUCKET=true
      - S3_FORCE_PATH_STYLE=true
      - EMAIL=false
      - FRONTEND_ORIGIN=https://speckle.structura-most.ru
      - DISABLE_WORKSPACES=true
    networks:
      - web
      - internal
    depends_on:
      postgres_speckle:
        condition: service_healthy
      redis:
        condition: service_healthy
    extra_hosts:
      - "s3.structura-most.ru:host-gateway"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.speckle-api.rule=Host(`speckle.structura-most.ru`) && PathPrefix(`/graphql`, `/api`, `/objects`, `/auth/`, `/explorer`)"
      - "traefik.http.routers.speckle-api.entrypoints=web"
      - "traefik.http.routers.speckle-api.middlewares=speckle-https-redirect"
      - "traefik.http.routers.speckle-api-secure.rule=Host(`speckle.structura-most.ru`) && PathPrefix(`/graphql`, `/api`, `/objects`, `/auth/`, `/explorer`)"
      - "traefik.http.routers.speckle-api-secure.entrypoints=websecure"
      - "traefik.http.routers.speckle-api-secure.tls=true"
      - "traefik.http.routers.speckle-api-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.speckle-api-secure.middlewares=speckle-headers"
      - "traefik.http.routers.speckle-api-secure.service=speckle-api"
      - "traefik.http.services.speckle-api.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.speckle-headers.headers.customrequestheaders.X-Forwarded-Proto=https"

  # Speckle Preview Service
  speckle-preview:
    image: speckle/speckle-preview-service:latest
    container_name: speckle-preview
    restart: unless-stopped
    environment:
      - DEBUG=preview-service:*
      - SPECKLE_SERVER_URL=http://speckle-server:3000
      - PG_CONNECTION_STRING=postgres://${POSTGRES_SPECKLE_USER:-speckle}:${POSTGRES_SPECKLE_PASSWORD:-speckle_pass}@postgres_speckle:5432/${POSTGRES_SPECKLE_DB:-speckle}
      - REDIS_URL=redis://default:${REDIS_PASSWORD:-redis_pass}@redis:6379
      - PORT=3000
    networks:
      - internal
    depends_on:
      postgres_speckle:
        condition: service_healthy
    extra_hosts:
      - "s3.structura-most.ru:host-gateway"

  # Speckle Webhook Service
  speckle-webhook:
    image: speckle/speckle-webhook-service:latest
    container_name: speckle-webhook
    restart: unless-stopped
    environment:
      - DEBUG=webhook-service:*
      - SPECKLE_SERVER_URL=http://speckle-server:3000
      - PG_CONNECTION_STRING=postgres://${POSTGRES_SPECKLE_USER:-speckle}:${POSTGRES_SPECKLE_PASSWORD:-speckle_pass}@postgres_speckle:5432/${POSTGRES_SPECKLE_DB:-speckle}
      - REDIS_URL=redis://default:${REDIS_PASSWORD:-redis_pass}@redis:6379
      - PORT=3000
    networks:
      - internal
    depends_on:
      postgres_speckle:
        condition: service_healthy
    extra_hosts:
      - "s3.structura-most.ru:host-gateway"

  # Speckle File Import Service
  speckle-fileimport:
    image: speckle/speckle-fileimport-service:latest
    container_name: speckle-fileimport
    restart: unless-stopped
    environment:
      - DEBUG=fileimport-service:*
      - SPECKLE_SERVER_URL=http://speckle-server:3000
      - PG_CONNECTION_STRING=postgres://${POSTGRES_SPECKLE_USER:-speckle}:${POSTGRES_SPECKLE_PASSWORD:-speckle_pass}@postgres_speckle:5432/${POSTGRES_SPECKLE_DB:-speckle}
      - REDIS_URL=redis://default:${REDIS_PASSWORD:-redis_pass}@redis:6379
      - PORT=3000
      - FILE_IMPORT_TIME_LIMIT_MIN=60
      - S3_ENDPOINT=http://minio:9000
      - S3_PUBLIC_ENDPOINT=https://s3.structura-most.ru
      - S3_IGNORE_SSL=true
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=speckle-server
      - S3_FORCE_PATH_STYLE=true
    networks:
      - internal
    extra_hosts:
      - "s3.structura-most.ru:host-gateway"

    depends_on:
      postgres_speckle:
        condition: service_healthy

  # MinIO Production Labels
  minio:
    environment:
      - MINIO_SERVER_URL=https://s3.structura-most.ru
      - MINIO_API_CORS_ALLOW_ORIGIN="*"
    networks:
      - web
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio.rule=Host(`s3.structura-most.ru`)"
      - "traefik.http.routers.minio.entrypoints=web"
      - "traefik.http.routers.minio.middlewares=minio-https-redirect"
      - "traefik.http.routers.minio-secure.rule=Host(`s3.structura-most.ru`)"
      - "traefik.http.routers.minio-secure.entrypoints=websecure"
      - "traefik.http.routers.minio-secure.tls=true"
      - "traefik.http.routers.minio-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.minio-secure.service=minio"
      - "traefik.http.services.minio.loadbalancer.server.port=9000"
      - "traefik.http.middlewares.minio-https-redirect.redirectscheme.scheme=https"

  # Refine Frontend (App)
  refine-frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: refine-frontend
    restart: unless-stopped
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.refine.rule=Host(`app.structura-most.ru`)"
      - "traefik.http.routers.refine.entrypoints=web"
      - "traefik.http.routers.refine.middlewares=refine-https-redirect"
      - "traefik.http.routers.refine-secure.rule=Host(`app.structura-most.ru`)"
      - "traefik.http.routers.refine-secure.entrypoints=websecure"
      - "traefik.http.routers.refine-secure.tls=true"
      - "traefik.http.routers.refine-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.refine-secure.service=refine"
      - "traefik.http.services.refine.loadbalancer.server.port=80"
      - "traefik.http.middlewares.refine-https-redirect.redirectscheme.scheme=https"

  # PostgREST (API)
  postgrest:
    image: postgrest/postgrest:v11.2.2
    container_name: postgrest
    restart: unless-stopped
    environment:
      PGRST_DB_URI: postgres://speckle:${POSTGRES_SPECKLE_PASSWORD:-speckle_pass}@postgres_speckle:5432/structura
      PGRST_DB_ANON_ROLE: web_anon
      PGRST_DB_SCHEMA: public
      PGRST_JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-token-with-at-least-32-characters-long}
      PGRST_OPENAPI_SERVER_PROXY_URI: https://api.structura-most.ru
    networks:
      - internal
      - web
    depends_on:
      postgres_speckle:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.postgrest.rule=Host(`api.structura-most.ru`)"
      - "traefik.http.routers.postgrest.entrypoints=web"
      - "traefik.http.routers.postgrest.middlewares=postgrest-https-redirect"
      - "traefik.http.routers.postgrest-secure.rule=Host(`api.structura-most.ru`)"
      - "traefik.http.routers.postgrest-secure.entrypoints=websecure"
      - "traefik.http.routers.postgrest-secure.tls=true"
      - "traefik.http.routers.postgrest-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.postgrest-secure.service=postgrest"
      - "traefik.http.services.postgrest.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.postgrest-https-redirect.redirectscheme.scheme=https"

  # Speckle Adapter (Custom Backend)
  speckle-adapter:
    build:
      context: ../backend/speckle_adapter
      dockerfile: Dockerfile
    container_name: speckle-adapter
    restart: unless-stopped
    environment:
      - SPECKLE_SERVER_URL=http://speckle-server:3000
      - SPECKLE_TOKEN=${SPECKLE_TOKEN:-missing_token}
      - ALLOW_ORIGINS=https://app.structura-most.ru
    networks:
      - web
      - internal
    depends_on:
      speckle-server:
        condition: service_started
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.adapter.rule=Host(`adapter.structura-most.ru`)"
      - "traefik.http.routers.adapter.entrypoints=web"
      - "traefik.http.routers.adapter.middlewares=adapter-https-redirect"
      - "traefik.http.routers.adapter-secure.rule=Host(`adapter.structura-most.ru`)"
      - "traefik.http.routers.adapter-secure.entrypoints=websecure"
      - "traefik.http.routers.adapter-secure.tls=true"
      - "traefik.http.routers.adapter-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.adapter-secure.service=adapter"
      - "traefik.http.services.adapter.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.adapter-https-redirect.redirectscheme.scheme=https"
